<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--
  ~    Copyright 2020 OICR
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd"
                   context="1.9.0">
    <changeSet author="dyuen" id="notification_seq">
        <addAutoIncrement tableName="notification" columnName="id" startWith="100"/>
    </changeSet>

    <changeSet author="dyuen" id="deduplicate_content">
        <createTable tableName="filecontent">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="filecontent_pkey"/>
            </column>
            <column name="content" type="TEXT"/>
            <column name="dbcreatedate" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="dbupdatedate" type="TIMESTAMP WITHOUT TIME ZONE"/>
        </createTable>
        <addColumn tableName="sourcefile">
            <column name="sha1" type="varchar(255 BYTE)"/>
        </addColumn>

        <!-- disable security to not skip frozen files -->
        <sql dbms="postgresql">
            alter table sourcefile disable row level security;
        </sql>

        <!-- copy over unique non-null content from sourcefile -->
        <sql>with uniquecontent as (select content, min(dbcreatedate) as dbcreatedate, max(dbupdatedate) as dbupdatedate from sourcefile where content is not null group by content) insert into filecontent(id, content, dbcreatedate, dbupdatedate) select encode(digest(content, 'sha1'), 'hex'), content, dbcreatedate, dbupdatedate from uniquecontent</sql>
        <!-- populate sha1 for main table -->
        <sql>update sourcefile set sha1 = encode(digest(content, 'sha1'), 'hex')</sql>

        <sql dbms="postgresql">
            alter table sourcefile enable row level security;
        </sql>
        <dropColumn columnName="content" tableName="sourcefile"/>
    </changeSet>

    <changeSet author="dyuen" id="constrain_filecontent">
        <addForeignKeyConstraint baseColumnNames="sha1" baseTableName="sourcefile" constraintName="filecontentsha1" deferrable="true" initiallyDeferred="true" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="filecontent"/>
    </changeSet>
</databaseChangeLog>
